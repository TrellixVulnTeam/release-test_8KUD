#!/usr/bin/env node

/* eslint-disable no-console */
/* eslint @typescript-eslint/no-var-requires: "off" */
const prompt = require('prompt');
const fs = require('fs');
const path = require('path');

const CONFIN_FILE_NAME = 'config.json';
const CONFIG_FILE_PATH = path.join(process.cwd(), CONFIN_FILE_NAME);

const LOCALE_FILE_NAME = 'locales.json';
const LOCALE_PATH_ROOT = 'https://cdn.airslate.com/locales/';
const LOCALE_BUILD_NUMBER = '1633';
const LOCALE_FILE_PATH = path.join(process.cwd(), '..', 'static-server', 'config', 'external', LOCALE_FILE_NAME);

let localeGetPathRoot = LOCALE_PATH_ROOT;
let localeGetBuildNumber = LOCALE_BUILD_NUMBER;
let localeGetPath = LOCALE_PATH_ROOT + LOCALE_BUILD_NUMBER;

try {
  const { localeBuildNumber, localeRootPath } = JSON.parse(fs.readFileSync(LOCALE_FILE_PATH));
  localeGetPathRoot = localeRootPath;
  localeGetBuildNumber = localeBuildNumber;
  localeGetPath = localeRootPath + localeBuildNumber;
} catch (error) {
  console.error(error);
}

if (!fs.existsSync(CONFIG_FILE_PATH)) {
  fs.writeFileSync(CONFIG_FILE_PATH, '{}');
  console.log(`Created "${CONFIN_FILE_NAME}".`);
}

const config = JSON.parse(fs.readFileSync(CONFIG_FILE_PATH).toString());

const schema = {
  properties: {
    env: {
      description: 'rc / stage / dev**',
      message: 'Input rc, stage, dev*',
      required: true,
    },
  },
};

prompt.start();

prompt.get(schema, (err, { env }) => {
  if (err) {
    console.error(err);
    return;
  }

  const isLikeProd = ['rc', 'stage'].includes(env);

  const defaultConfig = {
    AIRSLATE_ENV_CONFIGURATION: {
      API_HOST: `api.airslate-${env}.xyz`,
      API_INTEGRATIONS_HOST: `https://integrations.airslate-${env}.xyz`,
      STATIC_URL: '//cdn.airslate.com/static/131',
      MAIN_DOMAIN: 'airslate.localhost',
      API_SUPPORT_HOST: isLikeProd ? `https://sb-${env}.pdffiller.com/support/airslate` : 'https://sb-dev.pdffiller.com/support/airslate',
      API_SUPERVISOR_SOCKET_HOST: isLikeProd ? `https://sv-${env}.pdffiller.com:8081` : 'https://sv-dev.pdffiller.com:8091',
      WS_HOST: isLikeProd ? `wss://message-manager-ws.airslate-${env}.xyz` : `wss://airslate-${env}.xyz:8046`,
      DOC_CREATOR_FRAME_URL: isLikeProd ? 'https://devapp.pdffiller.com/en/createnewform/airslate' : 'https://devapp.pdffiller.com',
      POLICY_URL: `//www.airslate-${env}.xyz/privacy-policy`,
      TERMS_URL: `//www.airslate-${env}.xyz/terms-of-service`,
      GOOGLE_RECAPTCHA_V2_SITE_KEY: '________',
      GOOGLE_RECAPTCHA_V3_SITE_KEY: '________',
      MARKETING_SKS_LINK: 'https://cdn.mr-dev.xyz/sks/js/sks_track.js',
      ANDROID_MOBILE_APP_URL_FOR_DESKTOP: 'https://play.google.com/store/apps/details?id=com.airslate.android&referrer=utm_source%3DLoginWebDesktop',
      ANDROID_MOBILE_APP_URL_FOR_MOBILE: 'https://play.google.com/store/apps/details?id=com.airslate.android&referrer=utm_source%3DLoginWebMobile',
      IOS_MOBILE_APP_URL_FOR_DESKTOP: 'https://apps.apple.com/app/apple-store/id1437194974?pt=482524&ct=LoginWebDesktop&mt=8',
      IOS_MOBILE_APP_URL_FOR_MOBILE: 'https://apps.apple.com/app/apple-store/id1437194974?pt=482524&ct=LoginWebMobile&mt=8',
      IS_AUTO_TEST: false,
      SERVER_ID: 'blue',
      LOCALE_PATH: localeGetPath,
      LOCALE_PATH_ROOT: localeGetPathRoot,
      LOCALE_BUILD_NUMBER: localeGetBuildNumber,
      GOOGLE_CLIENT_ID: '799622306347-r7dnteb6stg220agaqna8gfc0ds5siim.apps.googleusercontent.com',
    },
    AIRSLATE_TEMP_DATA: {},
  };

  const nextConfig = {
    ...config,
    ...defaultConfig,
  };

  fs.writeFileSync(CONFIG_FILE_PATH, JSON.stringify(nextConfig, null, 2));

  console.log();
  console.log(`Updated "${CONFIN_FILE_NAME}"`);
  console.log();
});
